import streamlit as st
from datetime import datetime, timedelta
import plotly.graph_objects as go

st.set_page_config(page_title="ë ˜ìˆ˜ë©´ ê¸°ë°˜ ìˆ˜ë©´ ê³„ì‚°ê¸°", layout="centered")
st.title("ğŸ›Œ ë ˜ìˆ˜ë©´ ê¸°ë°˜ ìˆ˜ë©´ ì‹œê°„ ê³„ì‚°ê¸° + ì‹œê°í™”")

# ëª¨ë“œ ì„ íƒ
mode = st.radio("ëª¨ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”:", ("ìëŸ¬ ê°€ëŠ” ì‹œê°„ â†’ ê¸°ìƒ ì‹œê°„ ì¶”ì²œ", "ê¸°ìƒ ì‹œê°„ â†’ ìëŸ¬ ê°€ì•¼ í•  ì‹œê°„ ì¶”ì²œ"))

# ì‹œê°„ í¬ë§· í•¨ìˆ˜
def format_time(dt):
    return dt.strftime("%H:%M")

# Plotly ê·¸ë˜í”„ ìƒì„±
def create_sleep_chart(times, title):
    fig = go.Figure()
    for i, (label, time_obj) in enumerate(times):
        fig.add_trace(go.Bar(
            x=[1],
            y=[1],
            base=i,
            orientation='h',
            name=f"{label} - {format_time(time_obj)}",
            hovertext=format_time(time_obj),
            marker=dict(color=f"rgba({50+i*30}, {100+i*20}, 200, 0.6)")
        ))
    fig.update_layout(
        title=title,
        xaxis=dict(showticklabels=False),
        yaxis=dict(
            tickvals=list(range(len(times))),
            ticktext=[f"{label} ({format_time(time)})" for label, time in times],
            autorange="reversed"
        ),
        height=60 * len(times) + 100,
        showlegend=False,
    )
    return fig

# ìˆ˜ë©´ ì‹œê°„ â†’ ê¸°ìƒ ì‹œê°„ ì¶”ì²œ
if mode.startswith("ìëŸ¬"):
    sleep_input = st.time_input("ğŸ•’ ìëŸ¬ ê°€ëŠ” ì‹œê°„ ì„ íƒ", value=datetime.strptime("23:00", "%H:%M").time(), key="sleep_time_input")

    if st.button("ê¸°ìƒ ì‹œê°„ ê³„ì‚°", key="calculate_wake_time"):
        now = datetime.now()
        sleep_time = now.replace(hour=sleep_input.hour, minute=sleep_input.minute, second=0, microsecond=0)

        if sleep_time < now:
            sleep_time += timedelta(days=1)

        sleep_time += timedelta(minutes=15)  # ì ë“œëŠ” ë° ê±¸ë¦¬ëŠ” ì‹œê°„

        st.subheader("ì¶”ì²œ ê¸°ìƒ ì‹œê°„ â°")
        results = []
        for i in range(3, 7):  # 3~6 ì£¼ê¸°
            wake_time = sleep_time + timedelta(minutes=90 * i)
            st.markdown(f"- {i}ì£¼ê¸°: **{format_time(wake_time)}**")
            results.append((f"{i}ì£¼ê¸°", wake_time))

        fig = create_sleep_chart(results, "ì˜ˆìƒ ê¸°ìƒ ì‹œê°„")
        st.plotly_chart(fig, use_container_width=True)

# ê¸°ìƒ ì‹œê°„ â†’ ìˆ˜ë©´ ì‹œê°„ ì¶”ì²œ
else:
    wake_input = st.time_input("ğŸ•’ ê¸°ìƒ ì‹œê°„ ì„ íƒ", value=datetime.strptime("07:00", "%H:%M").time(), key="wake_time_input")

    if st.button("ì·¨ì¹¨ ì‹œê°„ ê³„ì‚°", key="calculate_sleep_time"):
        now = datetime.now()
        wake_time = now.replace(hour=wake_input.hour, minute=wake_input.minute, second=0, microsecond=0)

        if wake_time < now:
            wake_time += timedelta(days=1)

        st.subheader("ì¶”ì²œ ì·¨ì¹¨ ì‹œê°„ ğŸŒ™")
        results = []
        for i in range(6, 2, -1):  # 6~3 ì£¼ê¸°
            sleep_time = wake_time - timedelta(minutes=90 * i) - timedelta(minutes=15)
            st.markdown(f"- {i}ì£¼ê¸°: **{format_time(sleep_time)}**")
            results.append((f"{i}ì£¼ê¸°", sleep_time))

        fig = create_sleep_chart(results[::-1], "ì¶”ì²œ ì·¨ì¹¨ ì‹œê°„")
        st.plotly_chart(fig, use_container_width=True)
